"use strict";
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __esm = (fn, res) => function __init() {
  return fn && (res = (0, fn[__getOwnPropNames(fn)[0]])(fn = 0)), res;
};
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// node_modules/.pnpm/tsup@8.0.2_postcss@8.4.39_typescript@5.5.2/node_modules/tsup/assets/cjs_shims.js
var getImportMetaUrl, importMetaUrl;
var init_cjs_shims = __esm({
  "node_modules/.pnpm/tsup@8.0.2_postcss@8.4.39_typescript@5.5.2/node_modules/tsup/assets/cjs_shims.js"() {
    "use strict";
    getImportMetaUrl = () => typeof document === "undefined" ? new URL("file:" + __filename).href : document.currentScript && document.currentScript.src || new URL("main.js", document.baseURI).href;
    importMetaUrl = /* @__PURE__ */ getImportMetaUrl();
  }
});

// src/ProtocolImportsPlugin.ts
var ProtocolImportsPlugin_exports = {};
__export(ProtocolImportsPlugin_exports, {
  ProtocolImportsPlugin: () => ProtocolImportsPlugin
});
var ProtocolImportsPlugin;
var init_ProtocolImportsPlugin = __esm({
  "src/ProtocolImportsPlugin.ts"() {
    "use strict";
    init_cjs_shims();
    ProtocolImportsPlugin = class {
      apply(compiler) {
        compiler.hooks.normalModuleFactory.tap(
          "NormalModuleReplacementPlugin",
          (nmf) => {
            nmf.hooks.beforeResolve.tap(
              "NormalModuleReplacementPlugin",
              (resource) => {
                if (/^node:/.test(resource.request)) {
                  resource.request = resource.request.replace(/^node:/, "");
                }
              }
            );
          }
        );
      }
    };
  }
});

// src/index.ts
var src_exports = {};
__export(src_exports, {
  PLUGIN_NODE_POLYFILL_NAME: () => PLUGIN_NODE_POLYFILL_NAME,
  pluginNodePolyfill: () => pluginNodePolyfill
});
module.exports = __toCommonJS(src_exports);
init_cjs_shims();

// src/libs.ts
var libs_exports = {};
__export(libs_exports, {
  _stream_duplex: () => _stream_duplex,
  _stream_passthrough: () => _stream_passthrough,
  _stream_readable: () => _stream_readable,
  _stream_transform: () => _stream_transform,
  _stream_writable: () => _stream_writable,
  assert: () => assert,
  buffer: () => buffer,
  child_process: () => child_process,
  cluster: () => cluster,
  console: () => console,
  constants: () => constants,
  crypto: () => crypto,
  dgram: () => dgram,
  dns: () => dns,
  domain: () => domain,
  events: () => events,
  fs: () => fs,
  http: () => http,
  https: () => https,
  module: () => module2,
  net: () => net,
  os: () => os,
  path: () => path,
  process: () => process,
  punycode: () => punycode,
  querystring: () => querystring,
  readline: () => readline,
  repl: () => repl,
  stream: () => stream,
  string_decoder: () => string_decoder,
  sys: () => sys,
  timers: () => timers,
  tls: () => tls,
  tty: () => tty,
  url: () => url,
  util: () => util,
  vm: () => vm,
  zlib: () => zlib
});
init_cjs_shims();
var import_node_module = require("module");
var require2 = (0, import_node_module.createRequire)(importMetaUrl);
var assert = require2.resolve("assert/");
var buffer = require2.resolve("buffer/");
var child_process = null;
var cluster = null;
var console = require2.resolve("console-browserify");
var constants = require2.resolve("constants-browserify");
var crypto = require2.resolve("crypto-browserify");
var dgram = null;
var dns = null;
var domain = require2.resolve("domain-browser");
var events = require2.resolve("events/");
var fs = null;
var http = require2.resolve("stream-http");
var https = require2.resolve("https-browserify");
var module2 = null;
var net = null;
var os = require2.resolve("os-browserify/browser.js");
var path = require2.resolve("path-browserify");
var punycode = require2.resolve("punycode/");
var process = require2.resolve("process/browser.js");
var querystring = require2.resolve("querystring-es3/");
var readline = null;
var repl = null;
var stream = require2.resolve("stream-browserify");
var _stream_duplex = require2.resolve(
  "readable-stream/lib/_stream_duplex.js"
);
var _stream_passthrough = require2.resolve(
  "readable-stream/lib/_stream_passthrough.js"
);
var _stream_readable = require2.resolve(
  "readable-stream/lib/_stream_readable.js"
);
var _stream_transform = require2.resolve(
  "readable-stream/lib/_stream_transform.js"
);
var _stream_writable = require2.resolve(
  "readable-stream/lib/_stream_writable.js"
);
var string_decoder = require2.resolve("string_decoder/");
var sys = require2.resolve("util/util.js");
var timers = require2.resolve("timers-browserify");
var tls = null;
var tty = require2.resolve("tty-browserify");
var url = require2.resolve("url/");
var util = require2.resolve("util/util.js");
var vm = require2.resolve("vm-browserify");
var zlib = require2.resolve("browserify-zlib");

// src/index.ts
var getResolveFallback = (protocolImports) => {
  const fallback = {};
  for (const name of Object.keys(libs_exports)) {
    const libPath = libs_exports[name];
    fallback[name] = libPath ?? false;
    if (protocolImports) {
      fallback[`node:${name}`] = fallback[name];
    }
  }
  return fallback;
};
var getProvideGlobals = async (globals) => {
  const result = {};
  if (globals?.Buffer !== false) {
    result.Buffer = [buffer, "Buffer"];
  }
  if (globals?.process !== false) {
    result.process = [process];
  }
  return result;
};
var PLUGIN_NODE_POLYFILL_NAME = "rsbuild:node-polyfill";
function pluginNodePolyfill(options = {}) {
  const { protocolImports = true } = options;
  return {
    name: PLUGIN_NODE_POLYFILL_NAME,
    setup(api) {
      api.modifyBundlerChain(async (chain, { isServer, bundler }) => {
        if (isServer) {
          return;
        }
        chain.resolve.fallback.merge(getResolveFallback(protocolImports));
        const provideGlobals = await getProvideGlobals(options.globals);
        if (Object.keys(provideGlobals).length) {
          chain.plugin("node-polyfill-provide").use(bundler.ProvidePlugin, [provideGlobals]);
        }
        if (protocolImports) {
          const { ProtocolImportsPlugin: ProtocolImportsPlugin2 } = await Promise.resolve().then(() => (init_ProtocolImportsPlugin(), ProtocolImportsPlugin_exports));
          chain.plugin("protocol-imports").use(ProtocolImportsPlugin2);
        }
      });
    }
  };
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  PLUGIN_NODE_POLYFILL_NAME,
  pluginNodePolyfill
});
